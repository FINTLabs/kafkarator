# Fint Aivenerator

Fint Aivenerator is an operator that creates a service user and ACL in Aiven. 
Username, password, ACL id and access certificate and -key will be stored in kubernetes secrets

## What does the operator do?

When a `AivenKafkaAcl` CR is **created**:
* The operator will create a service user and ACL in Aiven.
* Username, password and ACL id will be generated and stored in secrets along with access certificate and -key.

When a `AivenKafkaAcl` CR is **deleted**:
* The operator will delete the user and ACL from Aiven. 
* The operator will delete the secrets from Kubernetes.

## How to use the operator:

### AivenKafkaAcl
```yaml
apiVersion: "fintlabs.no/v1alpha1"
kind: AivenKafkaAcl
metadata:
  name: <name>
  labels:
    app.kubernetes.io/name: <name>
    app.kubernetes.io/instance: <instance>
    app.kubernetes.io/version: <version>
    app.kubernetes.io/component: <component>
    app.kubernetes.io/part-of: <part-of>
    fintlabs.no/team: <team>
spec:
  project: <project name>
  service: <service name>
  acl:
    - permission: <read | readwrite | write>
      topic: '<topic>'
```

### Example of Custom Resource

```yaml
apiVersion: "fintlabs.no/v1alpha1"
kind: AivenKafkaAcl
metadata:
  name: sample-user
  labels:
    app.kubernetes.io/name: sample-user
    app.kubernetes.io/instance: sample-test
    app.kubernetes.io/version: latest
    app.kubernetes.io/component: sample
    app.kubernetes.io/part-of: sample-test
    fintlabs.no/team: sample-test
spec:
  project: fintlabs-no
  service: kafka-test
  acls:
    - permission: read
      topic: '*sample-test'
    - permission: read
      topic: '*sample-test2'
```

#### Prerequisites
* Aiven account, project and service
* Aiven token and Aiven api base url in application.yaml

### Using the operator

* Building the application will create a CRD like below in `build/classes/java/META-INF/fabric8` folder:
```yaml
# Generated by Fabric8 CRDGenerator, manual edits might get overwritten!
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: aivenkafkaacls.fintlabs.no
spec:
  group: fintlabs.no
  names:
    kind: AivenKafkaAcl
    plural: aivenkafkaacls
    singular: aivenkafkaacl
  scope: Namespaced
  versions:
    - name: v1alpha1
      schema:
        openAPIV3Schema:
          properties:
            spec:
              properties:
                project:
                  type: string
                service:
                  type: string
                acls:
                  items:
                    properties:
                      topic:
                        type: string
                      permission:
                        type: string
                    type: object
                  type: array
              type: object
            status:
              properties:
                dependentResourceStatus:
                  items:
                    type: string
                  type: array
                errorMessage:
                  type: string
                observedGeneration:
                  type: integer
              type: object
          type: object
      served: true
      storage: true
      subresources:
        status: {}

```

* Apply the CRD to the cluster:
```bash
kubectl apply -f <CRD>.yml
```
* Create an application.yaml file in the `src/main/resources` folder in the format specified below:
```yaml
spring:
  application:
    name: aivenerator
aiven: 
  token: <token>
  apiBaseUrl: https://api.aiven.io/v1
```
* Run the application.
* Create a `AivenKafkaAcl` CR:
```yaml
apiVersion: "fintlabs.no/v1alpha1"
kind: AivenKafkaAcl
metadata:
  name: <name>
  labels:
    app.kubernetes.io/name: <name>
    app.kubernetes.io/instance: <instance>
    app.kubernetes.io/version: <version>
    app.kubernetes.io/component: <component>
    app.kubernetes.io/part-of: <part-of>
    fintlabs.no/team: <team>
spec:
  project: <project name>
  service: <service name>
  acl:
    - permission: <read | readwrite | write>
      topic: '<topic>'
```
* Apply the CR to the cluster:
```bash
kubectl apply -f <CR>.yml
```
* The operator will create a service user and ACL in Aiven, and store username, password, ACL id and access certificate and -key in kubernetes secrets. 
* To delete the user and ACL as well as related kubernetes secrets, delete the CR:
```bash
kubectl delete -f <CR>.yml
```